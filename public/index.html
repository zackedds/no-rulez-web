<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>NO RULEZ ‚Äî Web Edition</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    background: #0a0a0a;
    color: #e0e0e0;
    font-family: 'Courier New', Courier, monospace;
    min-height: 100vh;
    min-height: 100dvh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px;
    touch-action: manipulation;
    overflow-y: auto;
  }
  #game-container {
    max-width: 750px;
    width: 100%;
    text-align: left;
  }

  .logo {
    text-align: center;
    margin-bottom: 20px;
    user-select: none;
    transition: margin 0.3s;
  }
  .logo-horizontal {
    width: clamp(250px, 70vw, 500px);
    display: block;
    margin: 0 auto;
    filter: drop-shadow(0 0 10px rgba(255,85,85,0.4));
    transition: width 0.3s, margin 0.3s;
  }
  .logo-subtitle {
    color: #f1fa8c;
    font-size: clamp(0.65rem, 2.5vw, 0.9rem);
    margin-top: 10px;
    letter-spacing: 0.15em;
    transition: opacity 0.3s, height 0.3s;
  }
  /* Compact logo during gameplay */
  .logo.in-game {
    margin-bottom: 8px;
  }
  .logo.in-game .logo-horizontal {
    width: clamp(180px, 50vw, 350px);
  }
  .logo.in-game .logo-subtitle {
    display: none;
  }
  @keyframes flicker {
    0%, 95%, 100% { opacity: 1; }
    96% { opacity: 0.8; }
    97% { opacity: 1; }
    98% { opacity: 0.7; }
    99% { opacity: 1; }
  }

  .setup { text-align: center; margin: 30px 0; }
  .setup h2 { color: #f1fa8c; margin-bottom: 15px; }
  .mode-btn {
    display: block;
    width: 100%;
    max-width: 400px;
    margin: 8px auto;
    padding: 14px 20px;
    background: #1a1a2e;
    color: #e0e0e0;
    border: 1px solid #444;
    font-family: inherit;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.2s, border-color 0.2s;
  }
  .mode-btn:hover { background: #2a2a4e; border-color: #f1fa8c; }
  .name-input, .code-input {
    background: #111;
    color: #e0e0e0;
    border: 1px solid #555;
    padding: 10px 12px;
    font-family: inherit;
    font-size: 16px;
    width: 200px;
    margin: 5px;
  }
  .name-input:focus, .code-input:focus { outline: none; border-color: #f1fa8c; }
  .code-input {
    width: 120px;
    text-align: center;
    font-size: 24px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
  }
  .start-btn {
    padding: 12px 30px;
    background: #2a2a4e;
    color: #50fa7b;
    border: 1px solid #50fa7b;
    font-family: inherit;
    font-size: 14px;
    cursor: pointer;
    margin-top: 10px;
  }
  .start-btn:hover { background: #3a3a5e; }
  .start-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* Online lobby */
  .game-code-display {
    font-size: clamp(2.5rem, 12vw, 4rem);
    font-weight: 900;
    color: #50fa7b;
    letter-spacing: 0.3em;
    text-shadow: 0 0 10px #50fa7b, 0 0 20px #50fa7b;
    margin: 20px 0 10px;
  }
  .waiting-msg {
    color: #f1fa8c;
    font-size: 14px;
    margin: 10px 0;
  }
  @keyframes pulse-dots {
    0%, 80%, 100% { opacity: 0; }
    40% { opacity: 1; }
  }
  .dot-pulse span {
    animation: pulse-dots 1.4s infinite;
    font-size: 20px;
  }
  .dot-pulse span:nth-child(2) { animation-delay: 0.2s; }
  .dot-pulse span:nth-child(3) { animation-delay: 0.4s; }
  .online-sub-btn {
    display: inline-block;
    width: 180px;
    margin: 8px;
    padding: 14px 20px;
    background: #1a1a2e;
    color: #e0e0e0;
    border: 1px solid #444;
    font-family: inherit;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.2s, border-color 0.2s;
  }
  .online-sub-btn:hover { background: #2a2a4e; border-color: #50fa7b; }
  .error-msg {
    color: #ff5555;
    font-size: 13px;
    margin: 8px 0;
    min-height: 18px;
  }
  .back-btn {
    color: #666;
    background: none;
    border: 1px solid #444;
    padding: 8px 16px;
    font-family: inherit;
    font-size: 12px;
    cursor: pointer;
    margin-top: 15px;
  }
  .back-btn:hover { border-color: #888; color: #aaa; }

  /* Game code badge */
  .code-badge {
    position: absolute;
    top: 0;
    right: 0;
    background: #1a1a2e;
    border: 1px solid #444;
    padding: 4px 10px;
    font-size: 12px;
    color: #50fa7b;
    letter-spacing: 0.1em;
  }
  .turn-badge {
    color: #f1fa8c;
    font-size: 11px;
    font-weight: bold;
    margin-bottom: 2px;
    display: inline-block;
    background: #1a1a2e;
    padding: 2px 8px;
    border: 1px solid #444;
  }

  /* Waiting overlay for online */
  .waiting-turn {
    text-align: center;
    padding: 10px;
    color: #f1fa8c;
    font-size: 14px;
  }
  @keyframes pulse-bg {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
  }
  .waiting-turn .pulse { animation: pulse-bg 2s infinite; }

  .actions-display {
    display: none;
    border-left: 2px solid #444;
    padding: 4px 8px;
    margin-bottom: 6px;
    font-size: 12px;
    color: #999;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  .actions-display .action-line {
    margin: 2px 0;
    font-size: 12px;
  }
  .p1-color { color: #ff5555; }
  .p2-color { color: #6272a4; }
  .action-text { color: #f8f8f2; }
  .dim { color: #666; }

  .sep { color: #f1fa8c; font-weight: bold; overflow: hidden; font-size: 8px; line-height: 1; margin: 2px 0; }

  #narrative {
    margin: 6px 0;
    padding: 4px 0;
    font-size: 14px;
    color: #f8f8f2;
    font-weight: bold;
    min-height: 30px;
    line-height: 1.5;
    cursor: pointer;
  }

  .scene-image-wrapper {
    margin: 6px 0;
  }
  .scene-image-wrapper img {
    width: 100%;
    max-height: 280px;
    object-fit: contain;
    border: 1px solid #333;
    display: block;
  }
  .scene-image-wrapper .img-loading {
    color: #666;
    font-size: 11px;
    padding: 8px 0;
  }

  .scene-container {
    position: relative;
    overflow-x: auto;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    margin: 4px 0;
    max-height: 210px;
  }
  #scene {
    color: #8be9fd;
    font-size: 12px;
    line-height: 1.3;
    min-height: 30px;
    white-space: pre;
    margin: 0;
  }

  .hp-section { margin: 6px 0; }
  .hp-row {
    display: flex;
    align-items: center;
    margin: 6px 0;
    font-size: 13px;
  }
  .hp-name {
    width: 120px;
    text-align: right;
    font-weight: bold;
    margin-right: 10px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .hp-bar-bg {
    flex: 1;
    max-width: 300px;
    height: 18px;
    background: #333;
    position: relative;
    border: 1px solid #555;
  }
  .hp-bar-fill {
    height: 100%;
    transition: width 0.6s ease-in-out, background-color 0.6s;
  }
  .hp-value {
    margin-left: 10px;
    font-weight: bold;
    min-width: 50px;
  }

  .input-area { margin: 6px 0; display: none; }
  .turn-label { font-weight: bold; margin-bottom: 3px; font-size: 13px; }
  .action-input-row { display: flex; gap: 8px; align-items: flex-end; }
  #action-input {
    flex: 1;
    background: #111;
    color: #e0e0e0;
    border: 1px solid #555;
    padding: 10px;
    font-family: inherit;
    font-size: 16px;
    resize: none;
    overflow: hidden;
    min-height: 42px;
    max-height: 120px;
    line-height: 1.4;
  }
  #action-input:focus { outline: none; border-color: #f1fa8c; }
  .submit-btn, .retry-btn {
    padding: 10px 20px;
    background: #2a2a4e;
    color: #50fa7b;
    border: 1px solid #50fa7b;
    font-family: inherit;
    font-size: 14px;
    cursor: pointer;
    white-space: nowrap;
  }
  .submit-btn:hover, .retry-btn:hover { background: #3a3a5e; }
  .submit-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  #status {
    color: #666;
    font-size: 12px;
    margin: 4px 0;
    min-height: 16px;
  }

  .game-over {
    display: none;
    text-align: center;
    margin: 30px 0;
    padding: 20px;
    border: 2px solid #bd93f9;
    background: #1a1a2e;
  }
  .game-over-title {
    color: #bd93f9;
    font-size: 1.5rem;
    font-weight: 900;
    text-shadow: 0 0 10px #bd93f9, 0 0 20px #bd93f9;
    margin-bottom: 10px;
  }
  .game-over-winner {
    color: #50fa7b;
    font-size: 1.1rem;
    font-weight: bold;
  }
  .play-again-btn {
    margin-top: 15px;
    padding: 12px 30px;
    background: #2a2a4e;
    color: #f1fa8c;
    border: 1px solid #f1fa8c;
    font-family: inherit;
    font-size: 14px;
    cursor: pointer;
  }
  .play-again-btn:hover { background: #3a3a5e; }

  .char-count {
    color: #666;
    font-size: 11px;
    text-align: right;
    margin-top: 4px;
  }
  .char-count.warn { color: #ff5555; }

  .hidden { display: none !important; }

  @media (max-width: 600px) {
    body { padding: 6px; font-size: 14px; }
    .logo { margin-bottom: 10px; }
    .logo.in-game { margin-bottom: 4px; }
    .logo.in-game .logo-horizontal { width: clamp(160px, 45vw, 260px); }
    .hp-row {
      display: flex;
      flex-wrap: nowrap;
      align-items: center;
      margin: 3px 0;
    }
    .hp-name {
      width: auto;
      min-width: 60px;
      text-align: right;
      margin-right: 6px;
      margin-bottom: 0;
      font-size: 11px;
    }
    .hp-bar-bg { max-width: none; height: 14px; }
    .hp-value { font-size: 11px; min-width: 40px; }
    .action-input-row { flex-direction: row; }
    #action-input { width: 100%; font-size: 16px; padding: 8px; }
    .submit-btn, .retry-btn {
      padding: 8px 16px;
      font-size: 14px;
    }
    .mode-btn { padding: 16px 20px; font-size: 15px; }
    .online-sub-btn { display: block; width: 100%; max-width: 400px; margin: 8px auto; }
    .name-input { width: 100%; margin: 5px 0; }
    .code-input { width: 160px; }
    .start-btn { width: 100%; padding: 14px; font-size: 15px; }
    #narrative { font-size: 13px; line-height: 1.4; padding: 2px 0; }
    #scene { font-size: 10px; line-height: 1.15; }
    .sep { font-size: 6px; }
    .actions-display .action-line { font-size: 11px; }
    .hp-section { margin: 4px 0; }
    .input-area { margin: 4px 0; }
    .char-count { margin-top: 2px; }
  }
</style>
</head>
<body>
<div id="game-container" class="">

  <div class="logo">
    <img src="/logo-horizontal.png" alt="No Rulez" class="logo-horizontal">
    <div class="logo-subtitle">ANYTHING GOES.</div>
  </div>

  <!-- Setup -->
  <div id="setup" class="setup">
    <h2>SELECT MODE</h2>
    <button class="mode-btn" onclick="selectMode('pvp')">‚öîÔ∏è LOCAL MULTIPLAYER</button>
    <button class="mode-btn" onclick="selectMode('online')">üåê ONLINE MULTIPLAYER</button>
    <button class="mode-btn" onclick="selectMode('vs_ai')">ü•ä VS BRAWLBOT AI</button>
    <div id="name-inputs" class="hidden" style="margin-top:20px;"></div>
  </div>

  <!-- Game area -->
  <div id="game-area" class="hidden" style="position:relative;">
    <div id="code-badge" class="code-badge hidden"></div>

    <div id="actions-display" class="actions-display">
      <div id="p1-action" class="action-line"></div>
      <div id="p2-action" class="action-line"></div>
    </div>

    <div id="turn-badge" class="turn-badge hidden"></div>
    <div class="sep" id="sep-top"></div>
    <div id="narrative"></div>
    <div class="sep" id="sep-mid"></div>

    <div id="scene-image-wrapper" class="scene-image-wrapper" style="display:none;"></div>
    <div class="scene-container">
      <pre id="scene"></pre>
    </div>

    <div class="sep" id="sep-bot"></div>
    <div class="hp-section">
      <div class="hp-row">
        <span id="p1-name" class="hp-name p1-color"></span>
        <div class="hp-bar-bg"><div id="p1-bar" class="hp-bar-fill" style="width:100%;background:#ff5555;"></div></div>
        <span id="p1-hp" class="hp-value">100 HP</span>
      </div>
      <div class="hp-row">
        <span id="p2-name" class="hp-name p2-color"></span>
        <div class="hp-bar-bg"><div id="p2-bar" class="hp-bar-fill" style="width:100%;background:#6272a4;"></div></div>
        <span id="p2-hp" class="hp-value">100 HP</span>
      </div>
    </div>
    <div class="sep"></div>

    <div id="status"></div>

    <!-- Waiting for opponent turn (online) -->
    <div id="waiting-turn" class="waiting-turn hidden">
      <div class="pulse">Waiting for <span id="waiting-name"></span>...</div>
      <div class="dot-pulse" style="margin-top:8px;"><span>.</span><span>.</span><span>.</span></div>
    </div>

    <!-- Input area -->
    <div id="input-area" class="input-area">
      <div id="turn-label" class="turn-label"></div>
      <div class="action-input-row">
        <textarea id="action-input" placeholder="Describe your action..." maxlength="200" rows="1"></textarea>
        <button id="submit-btn" class="submit-btn" onclick="submitAction()">GO</button>
      </div>
      <div id="char-count" class="char-count">0 / 200</div>
    </div>

    <button id="retry-btn" class="retry-btn hidden" onclick="retryTurn()">Retry</button>

    <div id="game-over" class="game-over">
      <div class="game-over-title">GAME OVER</div>
      <div id="game-over-winner" class="game-over-winner"></div>
      <button class="play-again-btn" onclick="backToMenu()">PLAY AGAIN</button>
    </div>
  </div>

</div>

<script>
(function() {
  "use strict";

  let mode = null;
  let state = null;
  let turn = 1;
  let p1Action = "";
  let p2Action = "";
  let typewriterAbort = null;
  let pendingRetry = null;

  // Online state
  let onlineCode = null;
  let onlinePlayerNum = null;
  let pollTimer = null;
  let lastUpdated = 0;

  const $ = id => document.getElementById(id);

  function setGameMode(active) {
    document.querySelector(".logo").classList.toggle("in-game", active);
  }

  function backToMenu() {
    stopPolling();
    onlineCode = null;
    onlinePlayerNum = null;
    mode = null;
    state = null;
    turn = 1;
    p1Action = "";
    p2Action = "";
    setGameMode(false);
    $("game-area").classList.add("hidden");
    $("game-over").style.display = "none";
    $("setup").classList.remove("hidden");
    $("name-inputs").classList.add("hidden");
    $("name-inputs").innerHTML = "";
  }
  window.backToMenu = backToMenu;

  window.selectMode = function(m) {
    mode = m;
    const box = $("name-inputs");
    box.classList.remove("hidden");
    box.innerHTML = "";

    if (m === "online") {
      renderOnlineLobby(box);
    } else if (m === "vs_ai") {
      const label = document.createElement("div");
      label.textContent = "Your name:";
      label.style.color = "#ff5555";
      label.style.fontWeight = "bold";
      box.appendChild(label);
      const inp = document.createElement("input");
      inp.className = "name-input";
      inp.id = "p1-input";
      inp.maxLength = 30;
      inp.placeholder = "Player 1";
      box.appendChild(inp);
      box.appendChild(document.createElement("br"));
      const btn = document.createElement("button");
      btn.className = "start-btn";
      btn.textContent = "START";
      btn.onclick = () => startLocalGame(inp.value.trim() || "Player 1", "BRAWLBOT");
      box.appendChild(btn);
      inp.addEventListener("keydown", e => { if (e.key === "Enter") btn.click(); });
    } else {
      const l1 = document.createElement("div");
      l1.textContent = "Player 1:";
      l1.style.color = "#ff5555";
      l1.style.fontWeight = "bold";
      box.appendChild(l1);
      const i1 = document.createElement("input");
      i1.className = "name-input";
      i1.maxLength = 30;
      i1.placeholder = "Player 1";
      box.appendChild(i1);
      box.appendChild(document.createElement("br"));
      const l2 = document.createElement("div");
      l2.textContent = "Player 2:";
      l2.style.color = "#6272a4";
      l2.style.fontWeight = "bold";
      l2.style.marginTop = "8px";
      box.appendChild(l2);
      const i2 = document.createElement("input");
      i2.className = "name-input";
      i2.maxLength = 30;
      i2.placeholder = "Player 2";
      box.appendChild(i2);
      box.appendChild(document.createElement("br"));
      const btn = document.createElement("button");
      btn.className = "start-btn";
      btn.textContent = "START";
      btn.onclick = () => startLocalGame(i1.value.trim() || "Player 1", i2.value.trim() || "Player 2");
      box.appendChild(btn);
      i2.addEventListener("keydown", e => { if (e.key === "Enter") btn.click(); });
    }
  };

  // --- Online Lobby ---
  function renderOnlineLobby(box) {
    const title = document.createElement("div");
    title.style.color = "#50fa7b";
    title.style.fontWeight = "bold";
    title.style.marginBottom = "15px";
    title.textContent = "ONLINE MULTIPLAYER";
    box.appendChild(title);

    const btnCreate = document.createElement("button");
    btnCreate.className = "online-sub-btn";
    btnCreate.textContent = "CREATE GAME";
    btnCreate.onclick = () => showCreateForm(box);
    box.appendChild(btnCreate);

    const btnJoin = document.createElement("button");
    btnJoin.className = "online-sub-btn";
    btnJoin.textContent = "JOIN GAME";
    btnJoin.onclick = () => showJoinForm(box);
    box.appendChild(btnJoin);

    const back = document.createElement("button");
    back.className = "back-btn";
    back.textContent = "‚Üê Back";
    back.onclick = () => { box.classList.add("hidden"); box.innerHTML = ""; };
    box.appendChild(document.createElement("br"));
    box.appendChild(back);
  }

  function showCreateForm(box) {
    box.innerHTML = "";
    const label = document.createElement("div");
    label.textContent = "Your name:";
    label.style.color = "#ff5555";
    label.style.fontWeight = "bold";
    box.appendChild(label);
    const inp = document.createElement("input");
    inp.className = "name-input";
    inp.maxLength = 30;
    inp.placeholder = "Enter your name";
    box.appendChild(inp);
    box.appendChild(document.createElement("br"));
    const err = document.createElement("div");
    err.className = "error-msg";
    box.appendChild(err);
    const btn = document.createElement("button");
    btn.className = "start-btn";
    btn.textContent = "CREATE GAME";
    btn.onclick = () => doCreate(inp.value.trim(), btn, err, box);
    box.appendChild(btn);
    inp.addEventListener("keydown", e => { if (e.key === "Enter") btn.click(); });
    const back = document.createElement("button");
    back.className = "back-btn";
    back.textContent = "‚Üê Back";
    back.onclick = () => renderOnlineLobby((box.innerHTML = "", box));
    box.appendChild(document.createElement("br"));
    box.appendChild(back);
    inp.focus();
  }

  async function doCreate(name, btn, errEl, box) {
    if (!name) name = "Player 1";
    btn.disabled = true;
    btn.textContent = "Creating...";
    errEl.textContent = "";
    try {
      const resp = await fetch("/api/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ player_name: name }),
      });
      const data = await resp.json();
      if (!resp.ok) { errEl.textContent = data.error || "Failed"; btn.disabled = false; btn.textContent = "CREATE GAME"; return; }
      onlineCode = data.code;
      onlinePlayerNum = 1;
      lastUpdated = data.game.last_updated || 0;
      showWaitingForOpponent(box, data.code);
    } catch (e) {
      errEl.textContent = "Network error. Try again.";
      btn.disabled = false;
      btn.textContent = "CREATE GAME";
    }
  }

  function showWaitingForOpponent(box, code) {
    box.innerHTML = "";
    const t = document.createElement("div");
    t.style.color = "#f1fa8c";
    t.style.marginBottom = "5px";
    t.textContent = "Share this code with your opponent:";
    box.appendChild(t);
    const codeEl = document.createElement("div");
    codeEl.className = "game-code-display";
    codeEl.textContent = code;
    box.appendChild(codeEl);
    const w = document.createElement("div");
    w.className = "waiting-msg";
    w.innerHTML = 'Waiting for opponent to join <span class="dot-pulse"><span>.</span><span>.</span><span>.</span></span>';
    box.appendChild(w);
    const back = document.createElement("button");
    back.className = "back-btn";
    back.textContent = "Cancel";
    back.onclick = () => { stopPolling(); backToMenu(); };
    box.appendChild(back);

    // Start polling for p2 join
    startPolling(function(game) {
      if (game.p2_name) {
        stopPolling();
        startOnlineGame(game);
      }
    });
  }

  function showJoinForm(box) {
    box.innerHTML = "";
    const label = document.createElement("div");
    label.textContent = "Your name:";
    label.style.color = "#6272a4";
    label.style.fontWeight = "bold";
    box.appendChild(label);
    const nameInp = document.createElement("input");
    nameInp.className = "name-input";
    nameInp.maxLength = 30;
    nameInp.placeholder = "Enter your name";
    box.appendChild(nameInp);
    box.appendChild(document.createElement("br"));
    const label2 = document.createElement("div");
    label2.textContent = "Game code:";
    label2.style.color = "#50fa7b";
    label2.style.fontWeight = "bold";
    label2.style.marginTop = "10px";
    box.appendChild(label2);
    const codeInp = document.createElement("input");
    codeInp.className = "code-input";
    codeInp.maxLength = 6;
    codeInp.placeholder = "123456";
    box.appendChild(codeInp);
    box.appendChild(document.createElement("br"));
    const err = document.createElement("div");
    err.className = "error-msg";
    box.appendChild(err);
    const btn = document.createElement("button");
    btn.className = "start-btn";
    btn.textContent = "JOIN GAME";
    btn.onclick = () => doJoin(nameInp.value.trim(), codeInp.value.trim(), btn, err);
    box.appendChild(btn);
    codeInp.addEventListener("keydown", e => { if (e.key === "Enter") btn.click(); });
    const back = document.createElement("button");
    back.className = "back-btn";
    back.textContent = "‚Üê Back";
    back.onclick = () => renderOnlineLobby((box.innerHTML = "", box));
    box.appendChild(document.createElement("br"));
    box.appendChild(back);
    nameInp.focus();
  }

  async function doJoin(name, code, btn, errEl) {
    if (!name) name = "Player 2";
    if (!code || code.length !== 6) { errEl.textContent = "Enter a 6-digit code."; return; }
    btn.disabled = true;
    btn.textContent = "Joining...";
    errEl.textContent = "";
    try {
      const resp = await fetch("/api/join", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code: code, player_name: name }),
      });
      const data = await resp.json();
      if (!resp.ok) { errEl.textContent = data.error || "Failed"; btn.disabled = false; btn.textContent = "JOIN GAME"; return; }
      onlineCode = data.game.code;
      onlinePlayerNum = 2;
      lastUpdated = data.game.last_updated || 0;
      startOnlineGame(data.game);
    } catch (e) {
      errEl.textContent = "Network error. Try again.";
      btn.disabled = false;
      btn.textContent = "JOIN GAME";
    }
  }

  // --- Online Game ---
  function startOnlineGame(game) {
    setGameMode(true);
    state = {
      p1_name: game.p1_name,
      p2_name: game.p2_name,
      p1_hp: game.p1_hp,
      p2_hp: game.p2_hp,
      situation: game.situation,
      last_action: game.last_action,
    };
    turn = game.turn;

    $("setup").classList.add("hidden");
    $("game-area").classList.remove("hidden");
    $("actions-display").style.display = "none";

    $("code-badge").classList.add("hidden");

    $("p1-name").textContent = game.p1_name;
    $("p2-name").textContent = game.p2_name;
    updateHP();

    const sep = "‚îÅ".repeat(70);
    $("sep-top").textContent = sep;
    $("sep-mid").textContent = sep;
    $("sep-bot").textContent = sep;

    if (game.narrative) {
      $("narrative").textContent = game.narrative;
      $("scene").textContent = game.scene || "";
    } else {
      $("narrative").textContent = "The arena is set. " + game.p1_name + " vs " + game.p2_name + ". THERE ARE NO RULES.";
      $("scene").textContent =
        "     " + game.p1_name + "                    " + game.p2_name + "\n" +
        "       O                        O\n" +
        "      /|\\    ~~~~~~~~~~~~~~    /|\\\n" +
        "      / \\    |  NO  RULEZ |    / \\\n" +
        "             |  A R E N A |\n" +
        "             ~~~~~~~~~~~~~~\n" +
        "      .  *  . ANYTHING GOES .  *  .\n" +
        "   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~";
    }

    onlinePromptTurn(game);
  }

  function onlinePromptTurn(game) {
    $("retry-btn").classList.add("hidden");
    $("game-over").style.display = "none";
    $("waiting-turn").classList.add("hidden");
    $("input-area").style.display = "none";
    $("turn-badge").classList.remove("hidden");
    $("turn-badge").textContent = "TURN " + game.turn;

    if (game.status === "finished") {
      showGameOver();
      return;
    }

    const isMyTurn = game.current_player === onlinePlayerNum;
    const myName = onlinePlayerNum === 1 ? game.p1_name : game.p2_name;
    const oppName = onlinePlayerNum === 1 ? game.p2_name : game.p1_name;

    if (isMyTurn) {
      stopPolling();
      $("input-area").style.display = "block";
      const label = $("turn-label");
      label.textContent = "Your turn, " + myName + "!";
      label.className = "turn-label " + (onlinePlayerNum === 1 ? "p1-color" : "p2-color");
      $("action-input").value = "";
      $("action-input").disabled = false;
      $("action-input").style.opacity = "1";
      $("action-input").focus();
      $("submit-btn").disabled = false;
      $("status").textContent = "";
    } else {
      $("waiting-turn").classList.remove("hidden");
      $("waiting-name").textContent = oppName;
      $("status").textContent = "";
      startPolling(function(g) {
        lastUpdated = g.last_updated;
        state.p1_hp = g.p1_hp;
        state.p2_hp = g.p2_hp;
        state.situation = g.situation;
        state.last_action = g.last_action;
        turn = g.turn;
        updateHP();

        // Show last action
        if (g.last_actor && g.last_actor_action) {
          const actorName = g.last_actor === 1 ? g.p1_name : g.p2_name;
          const cls = g.last_actor === 1 ? "p1-color" : "p2-color";
          $("actions-display").style.display = "block";
          $("p1-action").innerHTML = "";
          $("p2-action").innerHTML = "";
          const targetLine = g.last_actor === 1 ? $("p1-action") : $("p2-action");
          const lbl = document.createElement("span");
          lbl.className = cls;
          lbl.textContent = actorName + " said: ";
          const txt = document.createElement("span");
          txt.className = "action-text";
          txt.textContent = g.last_actor_action;
          targetLine.appendChild(lbl);
          targetLine.appendChild(txt);
        }

        stopPolling();
        $("waiting-turn").classList.add("hidden");

        // Use server-generated image URL (shared between both players)
        if (g.image_url) {
          showImage(g.image_url);
        } else {
          $("scene-image-wrapper").style.display = "none";
          document.querySelector(".scene-container").style.display = "block";
        }

        (async function() {
          if (g.narrative) await typewrite($("narrative"), g.narrative);
          if (g.scene) $("scene").textContent = g.scene;
          onlinePromptTurn(g);
        })();
      });
    }
  }

  // --- Polling ---
  function startPolling(callback) {
    stopPolling();
    function doPoll() {
      if (document.hidden) return; // skip when tab hidden
      if (!onlineCode) return;
      fetch("/api/poll?code=" + encodeURIComponent(onlineCode) + "&since=" + lastUpdated)
        .then(r => r.json())
        .then(data => {
          if (data.changed && data.game) {
            lastUpdated = data.game.last_updated || lastUpdated;
            callback(data.game);
          }
        })
        .catch(() => {}); // silent fail, will retry
    }
    doPoll();
    pollTimer = setInterval(doPoll, 2000);
    // Resume polling when tab becomes visible
    document.addEventListener("visibilitychange", onVisChange);
  }

  function onVisChange() {
    if (!document.hidden && pollTimer && onlineCode) {
      // Immediate poll on tab re-focus
      fetch("/api/poll?code=" + encodeURIComponent(onlineCode) + "&since=" + lastUpdated)
        .then(r => r.json()).then(() => {}).catch(() => {});
    }
  }

  function stopPolling() {
    if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
    document.removeEventListener("visibilitychange", onVisChange);
  }

  // --- Local game (PvP + vs AI) ---
  function startLocalGame(p1, p2) {
    setGameMode(true);
    state = {
      p1_name: p1,
      p2_name: p2,
      p1_hp: 100,
      p2_hp: 100,
      situation: "An open arena stretches before both players. The air crackles with possibility. Anything can happen.",
      last_action: "None yet. The battle is about to begin!",
    };
    turn = 1;
    p1Action = "";
    p2Action = "";

    $("setup").classList.add("hidden");
    $("game-area").classList.remove("hidden");
    $("actions-display").style.display = "none";
    $("code-badge").classList.add("hidden");
    $("turn-badge").classList.add("hidden");
    $("waiting-turn").classList.add("hidden");

    $("p1-name").textContent = p1;
    $("p2-name").textContent = p2;
    updateHP();

    const sep = "‚îÅ".repeat(70);
    $("sep-top").textContent = sep;
    $("sep-mid").textContent = sep;
    $("sep-bot").textContent = sep;

    $("narrative").textContent = "The arena is set. " + p1 + " vs " + p2 + ". THERE ARE NO RULES.";
    $("scene").textContent =
      "  " + p1 + "  O        ARENA        O  " + p2 + "\n" +
      "       /|\\   ~ ANYTHING GOES ~  /|\\\n" +
      "       / \\  ~~~~~~~~~~~~~~~~~~  / \\";

    promptTurn();
  }

  function updateHP() {
    $("p1-hp").textContent = state.p1_hp + " HP";
    $("p2-hp").textContent = state.p2_hp + " HP";
    $("p1-bar").style.width = state.p1_hp + "%";
    $("p2-bar").style.width = state.p2_hp + "%";
    $("p1-bar").style.backgroundColor = state.p1_hp <= 25 ? "#ff2222" : "#ff5555";
    $("p2-bar").style.backgroundColor = state.p2_hp <= 25 ? "#4455aa" : "#6272a4";
  }

  function updateActionsDisplay() {
    const disp = $("actions-display");
    const a1 = $("p1-action");
    const a2 = $("p2-action");
    if (!p1Action && !p2Action) { disp.style.display = "none"; return; }
    disp.style.display = "block";
    a1.innerHTML = "";
    a2.innerHTML = "";
    if (p1Action) {
      const lbl = document.createElement("span");
      lbl.className = "p1-color";
      lbl.textContent = state.p1_name + " said: ";
      const txt = document.createElement("span");
      txt.className = "action-text";
      txt.textContent = p1Action;
      a1.appendChild(lbl);
      a1.appendChild(txt);
    } else {
      const s = document.createElement("span");
      s.className = "dim";
      s.textContent = state.p1_name + ": waiting...";
      a1.appendChild(s);
    }
    if (p2Action) {
      const lbl = document.createElement("span");
      lbl.className = "p2-color";
      lbl.textContent = state.p2_name + " said: ";
      const txt = document.createElement("span");
      txt.className = "action-text";
      txt.textContent = p2Action;
      a2.appendChild(lbl);
      a2.appendChild(txt);
    } else {
      const s = document.createElement("span");
      s.className = "dim";
      s.textContent = state.p2_name + ": waiting...";
      a2.appendChild(s);
    }
  }

  function typewrite(el, text) {
    return new Promise(resolve => {
      el.textContent = "";
      let i = 0;
      let skipped = false;
      function skip() {
        if (!skipped) { skipped = true; el.textContent = text; resolve(); }
      }
      typewriterAbort = skip;
      el.addEventListener("click", skip, { once: true });
      function tick() {
        if (skipped) return;
        if (i >= text.length) { typewriterAbort = null; resolve(); return; }
        const ch = text[i];
        el.textContent += ch;
        i++;
        let delay = 10;
        if (".!?‚Äî".includes(ch)) delay = 60;
        else if (ch === ",") delay = 30;
        setTimeout(tick, delay);
      }
      tick();
    });
  }

  function currentPlayer() { return turn % 2 === 1 ? 1 : 2; }
  function isAiTurn() { return mode === "vs_ai" && currentPlayer() === 2; }

  function promptTurn() {
    $("retry-btn").classList.add("hidden");
    $("game-over").style.display = "none";

    if (state.p1_hp <= 0 || state.p2_hp <= 0) { showGameOver(); return; }

    const pn = currentPlayer();
    const name = pn === 1 ? state.p1_name : state.p2_name;
    const color = pn === 1 ? "p1-color" : "p2-color";

    if (isAiTurn()) {
      $("input-area").style.display = "none";
      $("status").textContent = "BRAWLBOT is preparing...";
      setTimeout(() => doAiTurn(), 3000);
    } else {
      $("input-area").style.display = "block";
      const label = $("turn-label");
      label.textContent = name + "'s turn!";
      label.className = "turn-label " + color;
      $("action-input").value = "";
      $("action-input").disabled = false;
      $("action-input").style.opacity = "1";
      $("action-input").focus();
      $("submit-btn").disabled = false;
      $("status").textContent = "";
    }
  }

  window.submitAction = function() {
    const input = $("action-input");
    const action = input.value.trim();
    if (!action) return;
    $("submit-btn").disabled = true;
    input.disabled = true;
    input.style.opacity = "0.4";

    if (mode === "online") {
      submitOnlineAction(action);
    } else {
      const pn = currentPlayer();
      if (pn === 1) p1Action = action; else p2Action = action;
      updateActionsDisplay();
      resolveAction(pn === 1 ? state.p1_name : state.p2_name, pn, action);
    }
  };

  async function submitOnlineAction(action) {
    $("status").textContent = "The referee deliberates...";
    try {
      const resp = await fetch("/api/turn", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code: onlineCode, player_num: onlinePlayerNum, action: action }),
      });
      const data = await resp.json();
      if (!resp.ok) {
        $("status").textContent = data.error || "Error";
        pendingRetry = { type: "online", action };
        $("retry-btn").classList.remove("hidden");
        $("input-area").style.display = "none";
        return;
      }
      const g = data.game;
      lastUpdated = g.last_updated;
      state.p1_hp = g.p1_hp;
      state.p2_hp = g.p2_hp;
      state.situation = g.situation;
      state.last_action = g.last_action;
      turn = g.turn;

      $("input-area").style.display = "none";
      $("status").textContent = "";

      // Show own action
      $("actions-display").style.display = "block";
      $("p1-action").innerHTML = "";
      $("p2-action").innerHTML = "";
      const targetLine = onlinePlayerNum === 1 ? $("p1-action") : $("p2-action");
      const lbl = document.createElement("span");
      lbl.className = onlinePlayerNum === 1 ? "p1-color" : "p2-color";
      lbl.textContent = (onlinePlayerNum === 1 ? g.p1_name : g.p2_name) + " said: ";
      const txt = document.createElement("span");
      txt.className = "action-text";
      txt.textContent = action;
      targetLine.appendChild(lbl);
      targetLine.appendChild(txt);

      // Use server-generated image URL (shared between both players)
      if (g.image_url) {
        showImage(g.image_url);
      } else {
        $("scene-image-wrapper").style.display = "none";
        document.querySelector(".scene-container").style.display = "block";
      }

      if (g.narrative) await typewrite($("narrative"), g.narrative);
      if (g.scene) $("scene").textContent = g.scene;
      updateHP();

      onlinePromptTurn(g);
    } catch (e) {
      $("status").textContent = "Network error. Try again.";
      pendingRetry = { type: "online", action };
      $("retry-btn").classList.remove("hidden");
      $("input-area").style.display = "none";
    }
  }

  $("action-input").addEventListener("keydown", function(e) {
    if (e.key === "Enter" && !e.shiftKey && !$("submit-btn").disabled) {
      e.preventDefault();
      window.submitAction();
    }
  });
  $("action-input").addEventListener("input", function() {
    // Auto-grow textarea
    this.style.height = "auto";
    this.style.height = Math.min(this.scrollHeight, 120) + "px";
    const len = this.value.length;
    const counter = $("char-count");
    counter.textContent = len + " / 200";
    counter.className = len >= 180 ? "char-count warn" : "char-count";
  });
  // Prevent mobile scroll-jump on focus
  $("action-input").addEventListener("focus", function() {
    setTimeout(function() { window.scrollTo(0, 0); }, 300);
  });

  async function doAiTurn() {
    const pn = currentPlayer();
    const name = pn === 1 ? state.p1_name : state.p2_name;
    $("status").textContent = name + " is thinking...";
    try {
      const resp = await fetch("/api/opponent", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ state: state, ai_name: name, player_num: pn }),
      });
      if (!resp.ok) {
        const err = await resp.json().catch(() => ({ error: "Request failed" }));
        $("status").textContent = "Error: " + (err.error || "Unknown");
        pendingRetry = { type: "ai", pn, name };
        $("retry-btn").classList.remove("hidden");
        return;
      }
      const data = await resp.json();
      const action = data.action;
      if (pn === 1) p1Action = action; else p2Action = action;
      updateActionsDisplay();
      $("status").textContent = name + ": " + action;
      resolveAction(name, pn, action);
    } catch (e) {
      $("status").textContent = "Network error. Check your connection.";
      pendingRetry = { type: "ai", pn, name };
      $("retry-btn").classList.remove("hidden");
    }
  }

  // Show a pre-generated image URL (used for online multiplayer)
  function showImage(url) {
    var wrapper = $("scene-image-wrapper");
    var sceneContainer = document.querySelector(".scene-container");
    wrapper.style.display = "block";
    wrapper.innerHTML = "";
    sceneContainer.style.display = "none";
    var img = document.createElement("img");
    img.src = url;
    img.alt = "Battle scene";
    img.onload = function() { wrapper.innerHTML = ""; wrapper.appendChild(img); };
    img.onerror = function() { wrapper.style.display = "none"; sceneContainer.style.display = "block"; };
  }

  // Generate image client-side (used for local/AI games)
  function generateImage(prompt) {
    if (!prompt) {
      $("scene-image-wrapper").style.display = "none";
      document.querySelector(".scene-container").style.display = "block";
      return;
    }
    var wrapper = $("scene-image-wrapper");
    var sceneContainer = document.querySelector(".scene-container");
    wrapper.style.display = "block";
    wrapper.innerHTML = '<div class="img-loading">Generating image...</div>';
    sceneContainer.style.display = "none";
    fetch("/api/image", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt: prompt }),
    })
    .then(r => r.json())
    .then(data => {
      if (data.image_url) {
        var img = document.createElement("img");
        img.src = data.image_url;
        img.alt = "Battle scene";
        img.onload = function() { wrapper.innerHTML = ""; wrapper.appendChild(img); };
        img.onerror = function() { wrapper.style.display = "none"; sceneContainer.style.display = "block"; };
      } else {
        wrapper.style.display = "none";
        sceneContainer.style.display = "block";
      }
    })
    .catch(function() { wrapper.style.display = "none"; sceneContainer.style.display = "block"; });
  }

  async function resolveAction(playerName, playerNum, action) {
    $("status").textContent = "The referee deliberates...";
    try {
      const resp = await fetch("/api/referee", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ state: state, player_name: playerName, player_num: playerNum, action: action }),
      });
      if (!resp.ok) {
        const err = await resp.json().catch(() => ({ error: "Request failed" }));
        const msg = err.error || "Unknown error";
        $("status").textContent = msg.includes("fumbled") ? "Referee fumbled! Try again." : "Error: " + msg;
        pendingRetry = { type: "resolve", playerName, playerNum, action };
        $("retry-btn").classList.remove("hidden");
        $("input-area").style.display = "none";
        return;
      }
      const data = await resp.json();
      state.p1_hp = data.state.p1_hp;
      state.p2_hp = data.state.p2_hp;
      state.situation = data.state.situation;
      state.last_action = data.state.last_action;
      $("input-area").style.display = "none";
      $("status").textContent = "";

      // Fire off image generation async (don't block game)
      if (data.state.image_safe && data.state.image_prompt) {
        generateImage(data.state.image_prompt);
      } else {
        $("scene-image-wrapper").style.display = "none";
      }

      await typewrite($("narrative"), data.narrative);
      $("scene").textContent = data.scene;
      updateHP();
      turn++;
      promptTurn();
    } catch (e) {
      $("status").textContent = "Network error. Check your connection.";
      pendingRetry = { type: "resolve", playerName, playerNum, action };
      $("retry-btn").classList.remove("hidden");
      $("input-area").style.display = "none";
    }
  }

  window.retryTurn = function() {
    $("retry-btn").classList.add("hidden");
    if (!pendingRetry) { if (mode === "online") return; promptTurn(); return; }
    if (pendingRetry.type === "ai") {
      doAiTurn();
    } else if (pendingRetry.type === "resolve") {
      resolveAction(pendingRetry.playerName, pendingRetry.playerNum, pendingRetry.action);
    } else if (pendingRetry.type === "online") {
      // Re-show input with the action pre-filled
      $("input-area").style.display = "block";
      $("action-input").value = pendingRetry.action;
      $("action-input").disabled = false;
      $("action-input").style.opacity = "1";
      $("submit-btn").disabled = false;
      $("status").textContent = "";
    }
    pendingRetry = null;
  };

  function showGameOver() {
    $("input-area").style.display = "none";
    $("waiting-turn").classList.add("hidden");
    $("status").textContent = "";
    stopPolling();
    const winner = state.p1_hp <= 0 ? state.p2_name : state.p1_name;
    $("game-over").style.display = "block";
    $("game-over-winner").textContent = winner + " WINS THE MATCH!";
  }

})();
</script>
</body>
</html>
