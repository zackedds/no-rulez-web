<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NO RULEZ — Web Edition</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #0a0a0a;
    color: #e0e0e0;
    font-family: 'Courier New', Courier, monospace;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
  }
  #game-container {
    max-width: 750px;
    width: 100%;
    text-align: left;
  }

  /* Banner */
  .banner {
    color: #ff5555;
    font-weight: bold;
    text-align: center;
    white-space: pre;
    font-size: 11px;
    line-height: 1.2;
    margin-bottom: 20px;
  }

  /* Mode select */
  .setup { text-align: center; margin: 30px 0; }
  .setup h2 { color: #f1fa8c; margin-bottom: 15px; }
  .mode-btn {
    display: block;
    width: 100%;
    max-width: 400px;
    margin: 8px auto;
    padding: 12px 20px;
    background: #1a1a2e;
    color: #e0e0e0;
    border: 1px solid #444;
    font-family: inherit;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.2s, border-color 0.2s;
  }
  .mode-btn:hover { background: #2a2a4e; border-color: #f1fa8c; }
  .name-input {
    background: #111;
    color: #e0e0e0;
    border: 1px solid #555;
    padding: 8px 12px;
    font-family: inherit;
    font-size: 14px;
    width: 200px;
    margin: 5px;
  }
  .name-input:focus { outline: none; border-color: #f1fa8c; }
  .start-btn {
    padding: 10px 30px;
    background: #2a2a4e;
    color: #50fa7b;
    border: 1px solid #50fa7b;
    font-family: inherit;
    font-size: 14px;
    cursor: pointer;
    margin-top: 10px;
  }
  .start-btn:hover { background: #3a3a5e; }

  /* Actions display */
  .actions-display {
    display: none;
    border: 1px solid #444;
    padding: 10px 15px;
    margin-bottom: 15px;
    background: #111;
  }
  .actions-display .action-line {
    margin: 4px 0;
    font-size: 13px;
  }
  .p1-color { color: #ff5555; }
  .p2-color { color: #6272a4; }
  .action-text { color: #f8f8f2; }
  .dim { color: #666; }

  /* Separator */
  .sep { color: #f1fa8c; font-weight: bold; }

  /* Narrative */
  #narrative {
    margin: 10px 0;
    font-size: 14px;
    color: #f8f8f2;
    font-weight: bold;
    min-height: 60px;
    line-height: 1.5;
    cursor: pointer;
  }

  /* Scene */
  #scene {
    color: #8be9fd;
    font-size: 12px;
    line-height: 1.3;
    margin: 10px 0;
    min-height: 50px;
    white-space: pre;
  }

  /* HP Bars */
  .hp-section { margin: 15px 0; }
  .hp-row {
    display: flex;
    align-items: center;
    margin: 6px 0;
    font-size: 13px;
  }
  .hp-name {
    width: 120px;
    text-align: right;
    font-weight: bold;
    margin-right: 10px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .hp-bar-bg {
    flex: 1;
    max-width: 300px;
    height: 18px;
    background: #333;
    position: relative;
    border: 1px solid #555;
  }
  .hp-bar-fill {
    height: 100%;
    transition: width 0.6s ease-in-out, background-color 0.6s;
  }
  .hp-value {
    margin-left: 10px;
    font-weight: bold;
    min-width: 50px;
  }

  /* Input area */
  .input-area { margin: 15px 0; display: none; }
  .turn-label { font-weight: bold; margin-bottom: 5px; font-size: 14px; }
  .action-input-row { display: flex; gap: 8px; }
  #action-input {
    flex: 1;
    background: #111;
    color: #e0e0e0;
    border: 1px solid #555;
    padding: 10px;
    font-family: inherit;
    font-size: 14px;
  }
  #action-input:focus { outline: none; border-color: #f1fa8c; }
  .submit-btn, .next-btn, .retry-btn {
    padding: 10px 20px;
    background: #2a2a4e;
    color: #50fa7b;
    border: 1px solid #50fa7b;
    font-family: inherit;
    font-size: 14px;
    cursor: pointer;
    white-space: nowrap;
  }
  .submit-btn:hover, .next-btn:hover, .retry-btn:hover { background: #3a3a5e; }
  .submit-btn:disabled, .next-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  /* Status */
  #status {
    color: #666;
    font-size: 13px;
    margin: 10px 0;
    min-height: 18px;
  }

  /* Game over */
  .game-over {
    text-align: center;
    color: #bd93f9;
    font-weight: bold;
    margin: 20px 0;
    white-space: pre;
    font-size: 13px;
  }

  .hidden { display: none !important; }
</style>
</head>
<body>
<div id="game-container">

  <!-- Banner -->
  <div class="banner">
╔══════════════════════════════════════════════════╗
║              ███╗   ██╗ ██████╗                  ║
║              ████╗  ██║██╔═══██╗                 ║
║              ██╔██╗ ██║██║   ██║                 ║
║              ██║╚██╗██║██║   ██║                 ║
║              ██║ ╚████║╚██████╔╝                 ║
║              ╚═╝  ╚═══╝ ╚═════╝                  ║
║         ██████╗ ██╗   ██╗██╗     ███████╗███████╗║
║         ██╔══██╗██║   ██║██║     ██╔════╝╚══███╔╝║
║         ██████╔╝██║   ██║██║     █████╗    ███╔╝ ║
║         ██╔══██╗██║   ██║██║     ██╔══╝   ███╔╝  ║
║         ██║  ██║╚██████╔╝███████╗███████╗███████╗║
║         ╚═╝  ╚═╝ ╚═════╝ ╚══════╝╚══════╝╚══════╝║
║                                                  ║
║         WEB EDITION — ANYTHING GOES.             ║
╚══════════════════════════════════════════════════╝</div>

  <!-- Setup -->
  <div id="setup" class="setup">
    <h2>SELECT MODE</h2>
    <button class="mode-btn" onclick="selectMode('pvp')">[1] Player vs Player</button>
    <button class="mode-btn" onclick="selectMode('vs_ai')">[2] Player vs DeepSeek</button>
    <button class="mode-btn" onclick="selectMode('ai_vs_ai')">[3] DeepSeek vs DeepSeek</button>
    <div id="name-inputs" class="hidden" style="margin-top:20px;"></div>
  </div>

  <!-- Game area (hidden until start) -->
  <div id="game-area" class="hidden">
    <!-- Actions display -->
    <div id="actions-display" class="actions-display">
      <div id="p1-action" class="action-line"></div>
      <div id="p2-action" class="action-line"></div>
    </div>

    <div class="sep" id="sep-top"></div>
    <div id="narrative"></div>
    <div class="sep" id="sep-mid"></div>

    <pre id="scene"></pre>

    <div class="sep" id="sep-bot"></div>
    <div class="hp-section">
      <div class="hp-row">
        <span id="p1-name" class="hp-name p1-color"></span>
        <div class="hp-bar-bg"><div id="p1-bar" class="hp-bar-fill" style="width:100%;background:#ff5555;"></div></div>
        <span id="p1-hp" class="hp-value">100 HP</span>
      </div>
      <div class="hp-row">
        <span id="p2-name" class="hp-name p2-color"></span>
        <div class="hp-bar-bg"><div id="p2-bar" class="hp-bar-fill" style="width:100%;background:#6272a4;"></div></div>
        <span id="p2-hp" class="hp-value">100 HP</span>
      </div>
    </div>
    <div class="sep"></div>

    <div id="status"></div>

    <!-- Input area -->
    <div id="input-area" class="input-area">
      <div id="turn-label" class="turn-label"></div>
      <div class="action-input-row">
        <input type="text" id="action-input" placeholder="Describe your action (anything goes)..." maxlength="500">
        <button id="submit-btn" class="submit-btn" onclick="submitAction()">GO</button>
      </div>
    </div>

    <!-- Next turn button (AI vs AI) -->
    <button id="next-btn" class="next-btn hidden" onclick="nextAiTurn()">Next Turn</button>

    <!-- Retry button -->
    <button id="retry-btn" class="retry-btn hidden" onclick="retryTurn()">Retry</button>

    <!-- Game over -->
    <div id="game-over" class="game-over hidden"></div>
  </div>

</div>

<script>
(function() {
  "use strict";

  // --- Game state ---
  let mode = null;        // 'pvp', 'vs_ai', 'ai_vs_ai'
  let state = null;
  let turn = 1;
  let p1Action = "";
  let p2Action = "";
  let typewriterAbort = null;  // function to skip typewriter
  let pendingRetry = null;     // data for retry

  // --- DOM refs ---
  const $ = id => document.getElementById(id);

  // --- Mode selection ---
  window.selectMode = function(m) {
    mode = m;
    const box = $("name-inputs");
    box.classList.remove("hidden");

    if (m === "ai_vs_ai") {
      box.innerHTML = "";
      const info = document.createElement("p");
      info.textContent = "ALPHA vs OMEGA — two AIs enter, one AI leaves!";
      info.style.color = "#bd93f9";
      info.style.fontWeight = "bold";
      info.style.marginBottom = "10px";
      box.appendChild(info);
      const btn = document.createElement("button");
      btn.className = "start-btn";
      btn.textContent = "START";
      btn.onclick = () => startGame("ALPHA", "OMEGA");
      box.appendChild(btn);
    } else if (m === "vs_ai") {
      box.innerHTML = "";
      const label = document.createElement("div");
      label.textContent = "Your name:";
      label.style.color = "#ff5555";
      label.style.fontWeight = "bold";
      box.appendChild(label);
      const inp = document.createElement("input");
      inp.className = "name-input";
      inp.id = "p1-input";
      inp.maxLength = 30;
      inp.placeholder = "Player 1";
      box.appendChild(inp);
      box.appendChild(document.createElement("br"));
      const btn = document.createElement("button");
      btn.className = "start-btn";
      btn.textContent = "START";
      btn.onclick = () => startGame(inp.value.trim() || "Player 1", "DeepSeek");
      box.appendChild(btn);
      inp.addEventListener("keydown", e => { if (e.key === "Enter") btn.click(); });
    } else {
      box.innerHTML = "";
      const l1 = document.createElement("div");
      l1.textContent = "Player 1:";
      l1.style.color = "#ff5555";
      l1.style.fontWeight = "bold";
      box.appendChild(l1);
      const i1 = document.createElement("input");
      i1.className = "name-input";
      i1.maxLength = 30;
      i1.placeholder = "Player 1";
      box.appendChild(i1);
      box.appendChild(document.createElement("br"));
      const l2 = document.createElement("div");
      l2.textContent = "Player 2:";
      l2.style.color = "#6272a4";
      l2.style.fontWeight = "bold";
      l2.style.marginTop = "8px";
      box.appendChild(l2);
      const i2 = document.createElement("input");
      i2.className = "name-input";
      i2.maxLength = 30;
      i2.placeholder = "Player 2";
      box.appendChild(i2);
      box.appendChild(document.createElement("br"));
      const btn = document.createElement("button");
      btn.className = "start-btn";
      btn.textContent = "START";
      btn.onclick = () => startGame(i1.value.trim() || "Player 1", i2.value.trim() || "Player 2");
      box.appendChild(btn);
      i2.addEventListener("keydown", e => { if (e.key === "Enter") btn.click(); });
    }
  };

  function startGame(p1, p2) {
    state = {
      p1_name: p1,
      p2_name: p2,
      p1_hp: 100,
      p2_hp: 100,
      situation: "An open arena stretches before both players. The air crackles with possibility. Anything can happen.",
      last_action: "None yet. The battle is about to begin!",
    };
    turn = 1;
    p1Action = "";
    p2Action = "";

    $("setup").classList.add("hidden");
    $("game-area").classList.remove("hidden");
    $("actions-display").style.display = "none";

    $("p1-name").textContent = p1;
    $("p2-name").textContent = p2;
    updateHP();

    const sep = "━".repeat(70);
    $("sep-top").textContent = sep;
    $("sep-mid").textContent = sep;
    $("sep-bot").textContent = sep;

    $("narrative").textContent = "The arena is set. " + p1 + " and " + p2 + " face each other. THERE ARE NO RULES.";
    $("scene").textContent =
      "        " + p1 + "                          " + p2 + "\n" +
      "          O                                  O\n" +
      "         /|\\        THE ARENA AWAITS        /|\\\n" +
      "         / \\                               / \\\n" +
      "    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~";

    promptTurn();
  }

  // --- HP ---
  function updateHP() {
    $("p1-hp").textContent = state.p1_hp + " HP";
    $("p2-hp").textContent = state.p2_hp + " HP";
    $("p1-bar").style.width = state.p1_hp + "%";
    $("p2-bar").style.width = state.p2_hp + "%";
    // Color shift at low HP
    $("p1-bar").style.backgroundColor = state.p1_hp <= 25 ? "#ff2222" : "#ff5555";
    $("p2-bar").style.backgroundColor = state.p2_hp <= 25 ? "#4455aa" : "#6272a4";
  }

  // --- Actions display ---
  function updateActionsDisplay() {
    const disp = $("actions-display");
    const a1 = $("p1-action");
    const a2 = $("p2-action");

    if (!p1Action && !p2Action) {
      disp.style.display = "none";
      return;
    }
    disp.style.display = "block";

    a1.innerHTML = "";
    a2.innerHTML = "";

    if (p1Action) {
      const lbl = document.createElement("span");
      lbl.className = "p1-color";
      lbl.textContent = state.p1_name + " said: ";
      const txt = document.createElement("span");
      txt.className = "action-text";
      txt.textContent = p1Action;
      a1.appendChild(lbl);
      a1.appendChild(txt);
    } else {
      a1.innerHTML = "";
      const s = document.createElement("span");
      s.className = "dim";
      s.textContent = state.p1_name + ": waiting...";
      a1.appendChild(s);
    }

    if (p2Action) {
      const lbl = document.createElement("span");
      lbl.className = "p2-color";
      lbl.textContent = state.p2_name + " said: ";
      const txt = document.createElement("span");
      txt.className = "action-text";
      txt.textContent = p2Action;
      a2.appendChild(lbl);
      a2.appendChild(txt);
    } else {
      a2.innerHTML = "";
      const s = document.createElement("span");
      s.className = "dim";
      s.textContent = state.p2_name + ": waiting...";
      a2.appendChild(s);
    }
  }

  // --- Typewriter ---
  function typewrite(el, text) {
    return new Promise(resolve => {
      el.textContent = "";
      let i = 0;
      let skipped = false;

      function skip() {
        if (!skipped) {
          skipped = true;
          el.textContent = text;
          resolve();
        }
      }

      typewriterAbort = skip;
      el.addEventListener("click", skip, { once: true });

      function tick() {
        if (skipped) return;
        if (i >= text.length) {
          typewriterAbort = null;
          resolve();
          return;
        }
        const ch = text[i];
        el.textContent += ch;
        i++;
        let delay = 10;
        if (".!?—".includes(ch)) delay = 60;
        else if (ch === ",") delay = 30;
        setTimeout(tick, delay);
      }
      tick();
    });
  }

  // --- Turn logic ---
  function currentPlayer() {
    return turn % 2 === 1 ? 1 : 2;
  }

  function isAiTurn() {
    const pn = currentPlayer();
    return mode === "ai_vs_ai" || (mode === "vs_ai" && pn === 2);
  }

  function promptTurn() {
    $("retry-btn").classList.add("hidden");
    $("game-over").classList.add("hidden");

    if (state.p1_hp <= 0 || state.p2_hp <= 0) {
      showGameOver();
      return;
    }

    const pn = currentPlayer();
    const name = pn === 1 ? state.p1_name : state.p2_name;
    const color = pn === 1 ? "p1-color" : "p2-color";

    if (isAiTurn()) {
      if (mode === "ai_vs_ai") {
        $("input-area").style.display = "none";
        $("next-btn").classList.remove("hidden");
        $("next-btn").disabled = false;
        $("status").textContent = "Press Next Turn to continue.";
      } else {
        // vs_ai, AI turn auto-fires after a pause so player can read
        $("input-area").style.display = "none";
        $("next-btn").classList.add("hidden");
        $("status").textContent = "DeepSeek is preparing...";
        setTimeout(() => {
          doAiTurn();
        }, 3000);
      }
    } else {
      $("next-btn").classList.add("hidden");
      $("input-area").style.display = "block";
      const label = $("turn-label");
      label.textContent = name + "'s turn!";
      label.className = "turn-label " + color;
      $("action-input").value = "";
      $("action-input").disabled = false;
      $("action-input").style.opacity = "1";
      $("action-input").focus();
      $("submit-btn").disabled = false;
      $("status").textContent = "";
    }
  }

  // --- Submit human action ---
  window.submitAction = function() {
    const input = $("action-input");
    const action = input.value.trim();
    if (!action) return;
    $("submit-btn").disabled = true;
    input.disabled = true;
    input.style.opacity = "0.4";

    const pn = currentPlayer();
    if (pn === 1) p1Action = action;
    else p2Action = action;
    updateActionsDisplay();

    resolveAction(pn === 1 ? state.p1_name : state.p2_name, pn, action);
  };

  $("action-input").addEventListener("keydown", function(e) {
    if (e.key === "Enter" && !$("submit-btn").disabled) {
      window.submitAction();
    }
  });

  // --- AI turn ---
  window.nextAiTurn = function() {
    $("next-btn").disabled = true;
    doAiTurn();
  };

  async function doAiTurn() {
    const pn = currentPlayer();
    const name = pn === 1 ? state.p1_name : state.p2_name;
    $("status").textContent = name + " is thinking...";

    try {
      const resp = await fetch("/api/opponent", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          state: state,
          ai_name: name,
          player_num: pn,
        }),
      });
      if (!resp.ok) {
        const err = await resp.json().catch(() => ({ error: "Request failed" }));
        $("status").textContent = "Error: " + (err.error || "Unknown");
        pendingRetry = { type: "ai", pn, name };
        $("retry-btn").classList.remove("hidden");
        $("next-btn").classList.add("hidden");
        return;
      }
      const data = await resp.json();
      const action = data.action;

      if (pn === 1) p1Action = action;
      else p2Action = action;
      updateActionsDisplay();

      $("status").textContent = name + ": " + action;
      resolveAction(name, pn, action);
    } catch (e) {
      $("status").textContent = "Network error. Check your connection.";
      pendingRetry = { type: "ai", pn, name };
      $("retry-btn").classList.remove("hidden");
      $("next-btn").classList.add("hidden");
    }
  }

  // --- Resolve with referee ---
  async function resolveAction(playerName, playerNum, action) {
    $("status").textContent = "The referee deliberates...";

    try {
      const resp = await fetch("/api/referee", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          state: state,
          player_name: playerName,
          player_num: playerNum,
          action: action,
        }),
      });

      if (!resp.ok) {
        const err = await resp.json().catch(() => ({ error: "Request failed" }));
        const msg = err.error || "Unknown error";
        if (msg.includes("fumbled")) {
          $("status").textContent = "Referee fumbled! Try again.";
        } else {
          $("status").textContent = "Error: " + msg;
        }
        pendingRetry = { type: "resolve", playerName, playerNum, action };
        $("retry-btn").classList.remove("hidden");
        $("input-area").style.display = "none";
        $("next-btn").classList.add("hidden");
        return;
      }

      const data = await resp.json();

      // Update state
      state.p1_hp = data.state.p1_hp;
      state.p2_hp = data.state.p2_hp;
      state.situation = data.state.situation;
      state.last_action = data.state.last_action;

      // Render
      $("input-area").style.display = "none";
      $("next-btn").classList.add("hidden");
      $("status").textContent = "";

      await typewrite($("narrative"), data.narrative);
      $("scene").textContent = data.scene;
      updateHP();

      turn++;
      promptTurn();

    } catch (e) {
      $("status").textContent = "Network error. Check your connection.";
      pendingRetry = { type: "resolve", playerName, playerNum, action };
      $("retry-btn").classList.remove("hidden");
      $("input-area").style.display = "none";
      $("next-btn").classList.add("hidden");
    }
  }

  // --- Retry ---
  window.retryTurn = function() {
    $("retry-btn").classList.add("hidden");
    if (!pendingRetry) { promptTurn(); return; }

    if (pendingRetry.type === "ai") {
      doAiTurn();
    } else if (pendingRetry.type === "resolve") {
      resolveAction(pendingRetry.playerName, pendingRetry.playerNum, pendingRetry.action);
    }
    pendingRetry = null;
  };

  // --- Game over ---
  function showGameOver() {
    $("input-area").style.display = "none";
    $("next-btn").classList.add("hidden");
    $("status").textContent = "";

    const winner = state.p1_hp <= 0 ? state.p2_name : state.p1_name;
    const el = $("game-over");
    el.classList.remove("hidden");
    el.textContent =
      "╔══════════════════════════════════════════════════╗\n" +
      "║                  GAME OVER                       ║\n" +
      "║                                                  ║\n" +
      "║   " + winner.padStart(24).padEnd(44) +  "   ║\n" +
      "║                 WINS THE MATCH!                  ║\n" +
      "╚══════════════════════════════════════════════════╝";
  }

})();
</script>
</body>
</html>
